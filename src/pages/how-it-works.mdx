---
layout: ../layouts/Page.astro
title: How it works
author: Rasso Hilber
description: Find out how Fragment Plugin works!
---

import Base from "../components/Base.astro";
import Hint from "../components/Hint.astro";
import { Code } from "astro/components";
import Icon from "../components/Icon.astro";

import { loadSwupJS, loadSwupCSS } from "../js/backend.js";
export const JS = loadSwupJS();
export const CSS = loadSwupCSS();

export const DataFragmentUrlExample = ``;


## Installation

```bash
npm install swup @swup/fragment-plugin
```

### Fragment support on this site is being achieved with:

1. [JavaScript](#javascript) for setting up fragment rules
2. [CSS](#css) for animating fragment visits
3. The [DOM](#dom) for special cases and extra functionality

## JavaScript

The following code is being used on this very site for initializing swup with fragment support:

{/* <Code code={JS} lang="js" /> */}

```js
import Swup from "swup";
import FragmentPlugin from "@swup/fragment-plugin";

/**
 * Define the rules for Fragment Plugin
 */
const rules = [
  // Rule 1: Between filters of the list
  {
    from: "/characters/:filter?",
    to: "/characters/:filter?",
    fragments: ["#list"],
  },
  // Rule 2: From the list to an overlay
  {
    from: "/characters/:filter?",
    to: "/character/:character",
    fragments: ["#overlay"],
    name: "open-overlay",
  },
  // Rule 3: From an overlay back to the list
  {
    from: "/character/:character",
    to: "/characters/:filter?",
    fragments: ["#overlay", "#list"],
    name: "close-overlay",
  },
  // Rule 4: Between overlays
  {
    from: "/character/:character",
    to: "/character/:character",
    fragments: ["#detail"],
  },
];

/**
 * Initialize Swup
 */
const swup = new Swup({
  plugins: [
    new FragmentPlugin({ rules }),
  ],
});
```

[Learn more about rules](https://github.com/swup/fragment-plugin#rules)

Did you notice something strange about rule 3? It's telling the plugin to
not only replace the `#overlay` but also the `#list`! Surely that's
not we want when we are closing an overlay, right?

Turns out: There are cases where we actually want that! When navigating to another
filter from an overlay, for example. Or when jumping multiple steps backwards or forwards
in the browser history.

**Fragment Plugin keeps track of the URL for each fragment as soon as it is being rendered.
On subsequent visits, the fragment won't be replaced if it already matches the visit's URL.**

## CSS

The CSS for the animations of fragment visits is scoped to the fragments:

{/* <Code code={CSS} lang="css" /> */}
```css
/* The default transition for non-fragment visits */
.transition-main {
  transition-property: opacity, transform;
  transition-duration: 250ms;
}

html.is-animating .transition-main {
  opacity: 0;
  transform: translateY(-20px);
}

html.is-leaving .transition-main {
  transform: translateY(20px);
}

/*
 * The transition when filtering the characters.
 * Here, we are animating the `.teaeser` elements individually
 */
#list.is-changing {
  --duration-leave: 150ms;
  --duration-enter: 400ms;
  transition-duration: var(--duration-enter);
}
#list.is-leaving {
  transition-duration: var(--duration-leave);
}
#list.is-changing .teaser {
  transition-property: opacity, transform;
  transition-duration: var(--duration-enter);
  transition-timing-function: cubic-bezier(0.230, 1.000, 0.320, 1.000); /* easeOutQuint */
}
#list.is-animating .teaser {
  opacity: 0;
  transform: scale(0.75);
}
/* Change easing and duration for the leave-phase */
#list.is-leaving .teaser {
  transition-timing-function: ease-in;
  transition-duration: var(--duration-leave);
}

/*
* The transition for opening and closing an overlay.
* The animation happens on the element itself
*/
#overlay.is-changing {
  transition: opacity 350ms;
}

#overlay.is-animating {
  opacity: 0;
}
/* Custom handling based on route */
#overlay.to-open-overlay.is-leaving,
#overlay.to-close-overlay.is-rendering {
  transition-duration: 1ms;
}

/*
* The transition between characters.
* The animation happens on the element itself
*/
#detail.is-changing {
  transition: opacity 200ms, transform 200ms;
}

#detail.is-animating {
  opacity: 0;
  transform: translateY(-20px);
}

#detail.is-leaving {
  opacity: 0;
  transform: translateY(20px);
}
```

## DOM

{/* <Hint hint={`this API is only required for advanced use cases`} /> */}

### [data-swup-fragment-url]

Let's visit one of the character detail pages directly,
<a href="/character/luigi/" target="_blank">Luigi</a>, for example.

The overlayed `#list` on that page displays the items that would be rendered when
navigating towards `/characters/`. But there is no way for Fragment Plugin to automatically
detect that fact, so it would replace the list upon closing the overlay.

We can solve this by providing the URL of the `#list` beforehand, by adding
the attribute `data-swup-fragment-url="/characters/"` to it. Now Fragment Plugin
can correctly skip the `#list` when we navigate from the overlay to `/characters/`:

```html title="/character/luigi/index.html" 'data-swup-fragment-url="/characters/"'
<main id="overlay">
	<!-- ...overlay content... -->
</main>
<div id="list" data-swup-fragment-url="/characters/">
	<!-- ...filters & characters... -->
</div>
```

[Learn more about this attribute](https://github.com/swup/fragment-plugin#fragment-url)

### [data-swup-link-to-fragment]

Using `[data-swup-link-to-fragment="<fragment-selector>"]`, you can tell any link on your site to be synced to the value of `[data-swup-fragment-url]`
of the fragment matching the provided selector. This is in use for the overlay close buttons on this site:

```html title="/character/luigi/index.html" 'data-link-to-fragment="#list"'
<main id="overlay">
  <!-- Tells the link to sync it's `href` to the fragment #list: -->
	<a href="" data-link-to-fragment="#list">Close overlay</a>
</main>
<div id="list" data-swup-fragment-url="/characters/">
	<!-- ...filters & characters... -->
</div>
```

[Learn more about this attribute](https://github.com/swup/fragment-plugin#link-to-fragment)