---
layout: ../layouts/Page.astro
title: How it works
author: Rasso Hilber
description: Find out how Fragment Plugin works!
---

import Base from "../components/Base.astro";
import Hint from "../components/Hint.astro";
import { Code } from "astro/components";
import Icon from "../components/Icon.astro";

import { loadSwupJS, loadSwupCSS } from "../js/backend.js";
export const JS = loadSwupJS();
export const CSS = loadSwupCSS();

export const DataFragmentUrlExample = ``;

## Installation

```bash
npm install swup @swup/fragment-plugin
```

### Fragment support on this site is being achieved with:

1. [JavaScript](#javascript) for setting up fragment rules
2. [CSS](#css) for animating fragment visits
3. The [DOM](#dom) for special cases and extra functionality

## JavaScript

The following code is being used on this very site for initializing swup with fragment support:

<Code code={JS} lang="js" />

[Learn more about rules](https://github.com/swup/fragment-plugin#rules)

Did you notice something strange about rule 3? It's telling the plugin to
not only replace the `#overlay` but also the `#list`! Surely that's
not we want when we are closing an overlay, right?

Turns out: There are cases where we actually want that! When navigating to another
filter from an overlay, for example. Or when jumping multiple steps backwards or forwards
in the browser history.

**Fragment Plugin keeps track of the URL for each fragment as soon as it is being rendered.
On subsequent visits, the fragment won't be replaced if it already matches the visit's URL.**

## CSS

The CSS for the animations of fragment visits is scoped to the fragments:

<Code code={CSS} lang="css" />

## DOM

### [data-swup-fragment-url]

Let's visit one of the character detail pages directly,
<a href="/character/luigi/" target="_blank">Luigi</a>, for example.

The overlayed `#list` on that page displays the items that would be rendered when
navigating towards `/characters/`. But there is no way for Fragment Plugin to automatically
detect that fact, so it would replace the list upon closing the overlay.

We can solve this by providing the URL of the `#list` beforehand, by adding
the attribute `data-swup-fragment-url="/characters/"` to it. Now Fragment Plugin
can correctly skip the `#list` when we navigate from the overlay to `/characters/`:

```html title="/character/luigi/index.html" 'data-swup-fragment-url="/characters/"'
<main id="overlay">
	<!-- ...overlay content... -->
</main>
<div id="list" data-swup-fragment-url="/characters/">
	<!-- ...filters & characters... -->
</div>
```

[Learn more about this attribute](https://github.com/swup/fragment-plugin#fragment-url)

### [data-swup-link-to-fragment]

Using `[data-swup-link-to-fragment="<fragment-selector>"]`, you can tell any link on your site to be synced to the value of `[data-swup-fragment-url]`
of the fragment matching the provided selector. This is in use for the overlay close buttons on this site:

```html title="/character/luigi/index.html" 'data-link-to-fragment="#list"'
<main id="overlay">
  <!-- Tells the link to sync it's `href` to the fragment #list: -->
	<a href="" data-link-to-fragment="#list">Close overlay</a>
</main>
<div id="list" data-swup-fragment-url="/characters/">
	<!-- ...filters & characters... -->
</div>
```

[Learn more about this attribute](https://github.com/swup/fragment-plugin#link-to-fragment)

### Modals inside `transform`ed parents

Suppose you have an overlay that you want to present like a modal, above all other content:

```html {10-15}
<div id="swup" class="transition-main">
  <section>
    <ul>
      <li><a href="/user/1/">User 1</a></li>
      <li><a href="/user/2/">User 2</a></li>
      <li><a href="/user/3/">User 3</a></li>
    </ul>
  </section>
  <!-- This should be placed above everything else -->
  <div id="user" class="modal">
    <main>
      <h1>User 1</h1>
      <p>Lorem ipsum dolor...</p>
    </main>
  </div>
</div>
```

You might have this (minimal) CSS to make the `#user` appear as a modal above everything else:

```css
.modal {
  position: fixed;
  inset: 0;
  z-index: 99999;
}
```

This will work fine, until you apply a `transform` to one of the modal's parent elements:

```css {7}
html.is-changing .transition-main {
  transition: opacity 250ms, transform 250ms;
}
html.is-animating .transition-main {
  opacity: 0;
  /* `transform` will misplace the .modal's positioning during an animated page visit */
  transform: translateY(20px);
}
```

The reason for this is that `transform` establishes a [containing block for all descendants](https://www.w3.org/TR/css-transforms-1/#containing-block-for-all-descendants).

You have two options to fix this:

1. Don't apply CSS `transform`s to any of the parents of a modal
2. Use `<detail open>` for the modal:

```diff lang="html"
- <div id="overlay" class="modal">
+ <dialog open id="overlay" aria-role="article">
    <main>
      <h1>User 1</h1>
      <p>Lorem ipsum dolor...</p>
    </main>
- </div>
+ </dialog>
```

Fragment Plugin will detect `<detail>` fragments automatically on every page view and run [`showModal()`](https://developer.mozilla.org/en-US/docs/Web/API/HTMLDialogElement/showModal) on them, putting them on the [top layer](https://developer.mozilla.org/en-US/docs/Glossary/Top_layer) and thus allows them to not be affected by parent element styles, anymore.

> **Note:** The second solution will produce [semantically incorrect markup](https://stackoverflow.com/a/75007908/586823), so you should only use it if you think you really have to. It's the cleanest solution for now, until the [Popover API](https://developer.mozilla.org/en-US/docs/Web/API/Popover_API) reaches [wider browser support](https://caniuse.com/?search=popover).
