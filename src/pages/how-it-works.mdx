---
layout: ../layouts/Page.astro
title: How it works
author: Rasso Hilber
description: Find out how Fragment Plugin works!
---

import Base from "../components/Base.astro";
import Hint from "../components/Hint.astro";
import { Code } from "astro/components";
import Icon from "../components/Icon.astro";

import { loadSwupJS, loadSwupCSS } from "../js/backend.js";
export const JS = loadSwupJS();
export const CSS = loadSwupCSS();

export const DataFragmentUrlExample = ``;


## Installation

```bash
npm install swup @swup/fragment-plugin
```

### Fragment support on this site is being achieved with:

1. [JavaScript](#javascript) for setting up fragment rules
2. [CSS](#css) for animating fragment visits
3. The [DOM](#dom) for special cases and extra functionality

## JavaScript

The following code is being used on this very site for initializing swup with fragment support:

{/* <Code code={JS} lang="js" /> */}
```js
import Swup from "swup";
import FragmentPlugin from "@swup/fragment-plugin";

/**
 * Define the rules for Fragment Plugin
 */
const rules = [
  // Rule 1: Between filters of the list
  {
    from: "/characters/:filter?",
    to: "/characters/:filter?",
    fragments: ["#list"],
  },
  // Rule 2: From the list to an overlay
  {
    from: "/characters/:filter?",
    to: "/character/:character",
    fragments: ["#overlay"],
    name: "open-overlay",
  },
  // Rule 3: From an overlay back to the list
  {
    from: "/character/:character",
    to: "/characters/:filter?",
    fragments: ["#overlay", "#list"],
    name: "close-overlay",
  },
  // Rule 4: Between overlays
  {
    from: "/character/:character",
    to: "/character/:character",
    fragments: ["#detail"],
  },
];

/**
 * Initialize Swup
 */
const swup = new Swup({
  plugins: [
    new FragmentPlugin({ rules }),
  ],
});
```

[Full documentation on rules](https://github.com/swup/fragment-plugin#rules)

Did you notice something strange about rule 3? It's telling the plugin to
not only replace the `#overlay` but also the `#list`! Surely that's
not we want when we are closing an overlay, right?

Turns out: There are cases where we actually want that! When navigating to another
filter from an overlay, for example. Or when jumping multiple steps backwards or forwards
in the browser history.

Fragment Plugin **keeps track of the URL for each fragment** when it is being rendered.
If a fragment already matches the current visit's URL, it **will be persisted**,
even though you gave the instructions to replace it for that visit.

There are scenarios where the plugin needs a little help by providing a fragment's URL from
the server for the initial visit. Read more about that in the [here](#dom)

## CSS

The CSS for the animations of fragment visits is scoped to the fragments:

{/* <Code code={CSS} lang="css" /> */}
```css
/* The default transition for non-fragment visits */
.transition-main {
  transition-property: opacity, transform;
  transition-duration: 250ms;
}

html.is-animating .transition-main {
  opacity: 0;
  transform: translateY(-20px);
}

html.is-leaving .transition-main {
  transform: translateY(20px);
}

/*
 * The transition when filtering the characters.
 * Here, we are animating the `.teaeser` elements individually
 */
#list.is-changing {
  --duration-leave: 150ms;
  --duration-enter: 400ms;
  transition-duration: var(--duration-enter);
}
#list.is-leaving {
  transition-duration: var(--duration-leave);
}
#list.is-changing .teaser {
  transition-property: opacity, transform;
  transition-duration: var(--duration-enter);
  transition-timing-function: cubic-bezier(0.230, 1.000, 0.320, 1.000); /* easeOutQuint */
}
#list.is-animating .teaser {
  opacity: 0;
  transform: scale(0.75);
}
/* Change easing and duration for the leave-phase */
#list.is-leaving .teaser {
  transition-timing-function: ease-in;
  transition-duration: var(--duration-leave);
}

/*
* The transition for opening and closing an overlay.
* The animation happens on the element itself
*/
#overlay.is-changing {
  transition: opacity 350ms;
}

#overlay.is-animating {
  opacity: 0;
}
/* Custom handling based on route */
#overlay.to-open-overlay.is-leaving,
#overlay.to-close-overlay.is-rendering {
  transition-duration: 0ms;
}

/*
* The transition between characters.
* The animation happens on the element itself
*/
#detail.is-changing {
  transition: opacity 200ms, transform 200ms;
}

#detail.is-animating {
  opacity: 0;
  transform: translateY(-20px);
}

#detail.is-leaving {
  opacity: 0;
  transform: translateY(20px);
}
```

## DOM

{/* <Hint hint={`this API is only required for advanced use cases`} /> */}

### [data-swup-fragment-url]

In some cases, there is no way for Fragment Plugin to know the URL of a
fragment beforehand. Suppose you visit one of the chracter detail pages
directly, <a href="/character/luigi/" target="_blank">Luigi</a>, for
example.

When closing the overlay on that page, Fragment Plugin **can't know if it
should replace the `#list` of characters or not**.

Adding `data-swup-fragment-url="/characters/"` to the `#list` will persist
it when closing the overlay/navigating towards [Characters](/characters/):

```astro title="/character/luigi/index.html" 'data-swup-fragment-url="/characters/"'
<main id="overlay">
	<!-- ...overlay content... -->
</main>
<div id="list" data-swup-fragment-url="/characters/">
	<!-- ...filters & characters... -->
</div>
```

### [data-swup-link-to-fragment]

Using `[data-swup-link-to-fragment="#fragment-id"]`, you can tell any link on your site to be synced to the value of `[data-swup-fragment-url]`
of any fragment. This is in use for the overlay close buttons over at [Characters](/characters/):

```html title="/character/luigi/index.html" 'data-link-to-fragment="#list"'
<main id="overlay">
	<a href="/characters/" data-link-to-fragment="#list">Close overlay</a>
	<!-- ...overlay content... -->
</main>
<div id="list" data-swup-fragment-url="/characters/">
	<!-- ...filters & characters... -->
</div>
```